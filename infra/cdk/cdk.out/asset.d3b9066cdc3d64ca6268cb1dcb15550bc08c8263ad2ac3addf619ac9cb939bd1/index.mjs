import{DynamoDBClient as N,GetItemCommand as A,DeleteItemCommand as E}from"@aws-sdk/client-dynamodb";import{SFNClient as x,SendTaskSuccessCommand as D,SendTaskFailureCommand as O}from"@aws-sdk/client-sfn";import{SSMClient as L,GetParameterCommand as M}from"@aws-sdk/client-ssm";import{createHmac as J}from"crypto";import{DynamoDBClient as C,PutItemCommand as m,UpdateItemCommand as S,QueryCommand as I}from"@aws-sdk/client-dynamodb";var l=class{ddb;paymentsTable;sagaTable;constructor(e,s,o){this.ddb=new C({region:e}),this.paymentsTable=process.env.PAYMENTS_IDEMPOTENCY_TABLE||s||"payments-idempotency",this.sagaTable=process.env.SAGA_TRANSACTIONS_TABLE||o||"saga-transactions"}async recordPaymentAttempt(e,s,o,i=24*60*60){let d=Math.floor(Date.now()/1e3)+i;await this.ddb.send(new m({TableName:this.paymentsTable,Item:{idempotencyKey:{S:e},correlationId:{S:s},amount:{N:o.toString()},status:{S:"pending"},createdAt:{S:new Date().toISOString()},ttl:{N:d.toString()}},ConditionExpression:"attribute_not_exists(idempotencyKey)"}))}async markPaymentCompleted(e,s){await this.ddb.send(new S({TableName:this.paymentsTable,Key:{idempotencyKey:{S:e}},UpdateExpression:"SET #s = :s, paymentIntentId = :pid, completedAt = :ts",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":s":{S:"completed"},":pid":{S:s},":ts":{S:new Date().toISOString()}}}))}async recordRefundAttempt(e,s,o,i=24*60*60){let d=Math.floor(Date.now()/1e3)+i;await this.ddb.send(new m({TableName:this.paymentsTable,Item:{idempotencyKey:{S:e},correlationId:{S:s},amount:{N:o.toString()},status:{S:"refund_pending"},createdAt:{S:new Date().toISOString()},ttl:{N:d.toString()}},ConditionExpression:"attribute_not_exists(idempotencyKey)"}))}async markRefundCompleted(e,s){await this.ddb.send(new S({TableName:this.paymentsTable,Key:{idempotencyKey:{S:e}},UpdateExpression:"SET #s = :s, refundId = :rid, completedAt = :ts",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":s":{S:"refund_completed"},":rid":{S:s},":ts":{S:new Date().toISOString()}}}))}async recordSagaStep(e,s,o,i,d,r=7){let c=Math.floor(Date.now()/1e3)+r*24*60*60;await this.ddb.send(new m({TableName:this.sagaTable,Item:{transactionId:{S:e},stepId:{S:s},correlationId:{S:o},action:{S:i},status:{S:d},timestamp:{S:new Date().toISOString()},ttl:{N:c.toString()}}}))}async recordSagaStepOnce(e,s,o,i,d,r=7){let c=Math.floor(Date.now()/1e3)+r*24*60*60;await this.ddb.send(new m({TableName:this.sagaTable,Item:{transactionId:{S:e},stepId:{S:s},correlationId:{S:o},action:{S:i},status:{S:d},timestamp:{S:new Date().toISOString()},ttl:{N:c.toString()}},ConditionExpression:"attribute_not_exists(transactionId) AND attribute_not_exists(stepId)"}))}async getSagaStepsByCorrelation(e){return(await this.ddb.send(new I({TableName:this.sagaTable,IndexName:"CorrelationIdIndex",KeyConditionExpression:"correlationId = :c",ExpressionAttributeValues:{":c":{S:e}}}))).Items||[]}};function f(t){if(t==null)return t;if(typeof t=="string")return t.replace(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/gi,"[REDACTED]");if(Array.isArray(t))return t.map(f);if(typeof t=="object"){let e=t,s={};for(let o of Object.keys(e))/password|secret|token|ssn|dob|email/i.test(o)?s[o]="[REDACTED]":s[o]=f(e[o]);return s}return t}function y(t,e,s){let o={level:t,msg:e,timestamp:new Date().toISOString(),pii:!1,...s},i=o.pii?{...o,msg:"[REDACTED]",pii:!1}:{...o},d=f(i),r=JSON.stringify(d);switch(t){case"debug":console.debug(r);break;case"info":console.info(r);break;case"warn":console.warn(r);break;case"error":console.error(r);break}}var n={debug:(t,e)=>y("debug",t,e),info:(t,e)=>y("info",t,e),warn:(t,e)=>y("warn",t,e),error:(t,e)=>y("error",t,e)};var b=new N({}),w=new x({}),B=new L({}),k=process.env.CALLBACK_TABLE||"pending-callbacks",h=process.env.WEBHOOK_SECRET_PARAM||"";async function X(t){let e=!!t&&(typeof t.headers=="object"||typeof t.body=="string"),s="",o="";if(e&&t.headers){let a=t.headers;s=a["X-Signature"]||a["x-signature"]||"",o=a["X-Timestamp"]||a["x-timestamp"]||"";let p=a["Content-Type"]||a["content-type"]||"";if(!/^application\/json(\s*;.*)?$/i.test(p))return n.warn("unsupported_media_type",{step:"webhook",state:"validate",errorType:"UnsupportedMediaType"}),{statusCode:415,body:JSON.stringify({ok:!1,error:"UnsupportedMediaType"})}}let i=e&&t.body||"",d=128*1024;if(e){let a=Buffer.byteLength(i,"utf8");if(a>d)return n.warn("payload_too_large",{step:"webhook",state:"validate",errorType:"PayloadTooLarge",size:a}),{statusCode:413,body:JSON.stringify({ok:!1,error:"PayloadTooLarge"})}}let r=t.correlationId,c=t.status;if(e&&i)try{let a=JSON.parse(i);r=r||a.correlationId,c=c||a.status}catch{}if(n.info("webhook_received",{correlationId:r,step:"webhook",state:"received"}),e){if(!s||!o)return n.warn("missing_signature",{step:"webhook",state:"auth",errorType:"MissingSignature"}),{statusCode:401,body:JSON.stringify({ok:!1,error:"MissingSignature"})};let a=Math.floor(Date.now()/1e3),p=Number(o);if(!Number.isFinite(p)||Math.abs(a-p)>300)return n.warn("stale_timestamp",{step:"webhook",state:"auth",errorType:"StaleTimestamp"}),{statusCode:401,body:JSON.stringify({ok:!1,error:"StaleTimestamp"})};if(!h)return n.error("server_misconfigured",{step:"webhook",state:"auth",errorType:"ConfigError"}),{statusCode:500,body:JSON.stringify({ok:!1,error:"ServerMisconfigured"})};let g="";try{g=(await B.send(new M({Name:h,WithDecryption:!0}))).Parameter?.Value||""}catch{return n.error("ssm_read_failed",{step:"webhook",state:"auth",errorType:"SecretUnavailable"}),{statusCode:500,body:JSON.stringify({ok:!1,error:"SecretUnavailable"})}}if(!g)return n.error("secret_unavailable",{step:"webhook",state:"auth",errorType:"SecretUnavailable"}),{statusCode:500,body:JSON.stringify({ok:!1,error:"SecretUnavailable"})};let T=`${i}.${p}`;if(J("sha256",g).update(T).digest("hex")!==s)return n.warn("invalid_signature",{correlationId:r,step:"webhook",state:"auth",errorType:"InvalidSignature"}),{statusCode:401,body:JSON.stringify({ok:!1,error:"InvalidSignature",correlationId:r||null})}}if(!r||c!=="confirmed"&&c!=="rejected")return e?{statusCode:400,body:JSON.stringify({ok:!1,error:"Invalid payload"})}:{ok:!1};try{await new l().recordSagaStep(r,"webhook_received",r,"provider_webhook","completed")}catch{n.warn("saga_record_failed",{correlationId:r,step:"webhook",state:"record",errorType:"SagaWriteFailed"})}let u=(await b.send(new A({TableName:k,Key:{correlationId:{S:r}}}))).Item?.taskToken?.S;if(!u)return n.warn("no_task_token",{correlationId:r,step:"webhook",state:"lookup",errorType:"MissingTaskToken"}),e?{statusCode:404,body:JSON.stringify({ok:!1})}:{ok:!1};try{if(c==="confirmed"){await w.send(new D({taskToken:u,output:JSON.stringify({status:"confirmed",correlationId:r})}));try{await new l().recordSagaStep(r,"callback_confirmed",r,"send_task_success","completed"),n.info("callback_confirmed",{correlationId:r,step:"webhook",state:"success"})}catch{n.warn("saga_record_failed",{correlationId:r,step:"webhook",state:"record",errorType:"SagaWriteFailed"})}}else{await w.send(new O({taskToken:u,error:"BookingRejected",cause:"Provider rejected booking"}));try{await new l().recordSagaStep(r,"callback_rejected",r,"send_task_failure","failed"),n.info("callback_rejected",{correlationId:r,step:"webhook",state:"failure"})}catch{n.warn("saga_record_failed",{correlationId:r,step:"webhook",state:"record",errorType:"SagaWriteFailed"})}}}finally{await b.send(new E({TableName:k,Key:{correlationId:{S:r}}}))}return e?{statusCode:200,body:JSON.stringify({ok:!0})}:{ok:!0}}export{X as handler};
