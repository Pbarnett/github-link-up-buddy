#!/bin/sh
# Block commits directly to main and enforce branch naming policy.
# Enable with: git config core.hooksPath .githooks
branch=$(git rev-parse --abbrev-ref HEAD)
if [ "$branch" = "main" ]; then
  echo "Abort: commit to main is blocked. Create a feature branch." 1>&2
  echo "Use: git switch -c feat/<topic> origin/main" 1>&2
  exit 1
fi
# Enforce branch naming convention for consistency
case "$branch" in
  feat/*|fix/*|chore/*|refactor/*|docs/*|test/*)
    ;;
  *)
    echo "Abort: branch '$branch' doesn’t follow naming policy (feat|fix|chore|refactor|docs|test)/<topic>." 1>&2
    echo "Use: git switch -c feat/<topic> origin/main" 1>&2
    exit 1
    ;;
 esac

# Scan staged TS/TSX files for stray control characters that break builds (e.g., \x03)
# Portable check using perl (works on macOS and Linux)
CONTROL_PATTERN='[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]'
files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx)$')
if [ -n "$files" ]; then
  found=0
  for f in $files; do
    if [ -f "$f" ]; then
      perl -ne "if (/$CONTROL_PATTERN/) { print qq{$f:$.: $_}; $found=1 } END { exit $found?1:0 }" "$f" >/tmp/ctrlchars.$$ 2>/dev/null
      if [ $? -ne 0 ]; then
        found=1
        echo "❌ Control characters detected in $f:" 1>&2
        cat /tmp/ctrlchars.$$ 1>&2 || true
      fi
      rm -f /tmp/ctrlchars.$$ 2>/dev/null || true
    fi
  done
  if [ "$found" -ne 0 ]; then
    echo "Abort: control characters found in staged files. Please remove them and retry commit." 1>&2
    echo "Hint: you can visualize them by opening the file in an editor and searching for non-printable chars or run:" 1>&2
    echo "      git grep -nI -P \"$CONTROL_PATTERN\" -- '*.ts' '*.tsx'" 1>&2
    exit 1
  fi
fi

